<!DOCTYPE html>
<link rel="stylesheet" href="style.css">
<html>
<head>
    <title>Decrypt and Show</title>
	<script src="buffer.js"></script>
	<script src="db.js"></script>
</head>
<body>
    <h2>Decrypt and show</h2>
    <input type="password" id="password" placeholder="Enter password">
    <button id="showTabBtn">show</button>
	<input type="checkbox" id="showPlayer">below
	<div>
		<video id="videoPlayer" controls width="100%" style="display:none;" ></video>
	</div>
	
	

    <script>
	     // Register the service worker
		if ('serviceWorker' in navigator) {
		  navigator.serviceWorker.register('/sw.js').then(() => {
			console.log('Service Worker registered');
		  });
		}
	
	
	    const checkbox = document.getElementById("showPlayer");
		const player = document.getElementById("videoPlayer");

		
		checkbox.addEventListener("change", () => {		
			player.style.display = checkbox.checked ? "block" : "none";		
		});

	
        document.getElementById("showTabBtn").onclick = async () => {
            const password = document.getElementById("password").value;
			// Fetch encrypted file from same folder on the server
            const response = await fetch("01AK-Cha Cha Cha.mp4.enc"); // Change filename if needed
            const arrayBuffer = await response.arrayBuffer();
			
            if (arrayBuffer && password) 
			{ 
				const decryptedArrayBuffer = await BUFFER().decrypt(arrayBuffer, password);
				
				if (decryptedArrayBuffer) 
				{
					if (!checkbox.checked) {
						//BUFFER().displayInTab(decryptedArrayBuffer, "video/mp4");
						//BUFFER().openArrayBufferInNewWindow(decryptedArrayBuffer, "video/mp4");
						const blob = new Blob([decryptedArrayBuffer], { type: "video/mp4" });
						await DB().saveToIndexedDB("files", "myFile", blob)
						
						// After decryption + storage
                        window.open("/download/myFile", "_blank");
                        // or <a href="/download/myfile" download>Download</a>

					}
					else {
						const blob = new Blob([decryptedArrayBuffer], { type: "video/mp4" });
						const url = URL.createObjectURL(blob);
						player.src = url;
						player.play();
					}
				}				
			}
        };
			
    </script>
</body>
</html>